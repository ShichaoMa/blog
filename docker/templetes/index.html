<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{{author}}的个人博客</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">

    <link href={{url_for("static", filename="img/favicon.ico")}} rel="icon" type="image/x-icon" />

    <!-- Bootstrap styles -->
    <link rel="stylesheet" href={{url_for("static", filename="css/bootstrap.min.css")}}>

    <!-- Font-Awesome -->
    <link rel="stylesheet" href={{url_for("static", filename="css/font-awesome/css/font-awesome.min.css")}}>

    <!-- Google Webfonts -->
    <!--<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600|PT+Serif:400,400italic' rel='stylesheet' type='text/css'>-->

    <!-- Styles -->
    <link rel="stylesheet" href={{url_for("static", filename="css/style.css")}} id="theme-styles">

    <!--[if lt IE 9]>
        <script src={{url_for("static", filename="js/vendor/google/html5-3.6-respond-1.1.0.min.js")}}></script>
    <![endif]-->

    <script src={{url_for("static", filename="js/jquery-1.12.4.min.js")}}></script>
    <script src={{url_for("static", filename="js/bootstrap.min.js")}}></script>
    <script src={{url_for("static", filename="js/modernizr.js")}}></script>
    <script src={{url_for("static", filename="js/react.js")}}></script>
    <script src={{url_for("static", filename="js/react-dom.js")}}></script>
    <script src={{url_for("static", filename="js/browser.min.js")}}></script>
    <script src={{url_for("static", filename="js/moment.min.js")}}></script>
    <script src={{url_for("static", filename="js/jqpage.js")}}></script>
</head>
<style>
    .span-right{
        float: right;
    }
</style>
<script type="text/babel">

    function gen_url(id){
        return '{{url_for("article")}}?id=' + id;
    }

    function parseDate(date){
        return moment(date, "YYYY-MM-DDTHH:mm:ss")
    }

    function gen_block(article, that){
        if(article){
            return (<Block {...article}>
                <div className="clearfix">
                    <a href="#" value={gen_url(article.id)}
                       className="btn btn-clean-one" onClick={that.handleClick}>更多</a>
                </div>
            </Block>)
        }
    }

    var common = {};


    class List extends React.Component {
        constructor(props) {
            super(props);
            this.handleClick = this.handleClick.bind(this);
            this.state = {};
        }

        handleClick(e) {
            this.props.parent.setState({url: null})

        }

        componentDidMount(){
            let that = this;
            $('#page').jqPaginator({
                totalCounts: this.props.count,
                pageSize: 20,
                visiblePages: 10,
                currentPage: 1,
                onPageChange: function (num, type) {
                    that.setState({
                        from: (num -1) *20,
                        size: 20,
                        url: "{{url_for('show')}}"
                    })
                }
            });
        }

        render(){
            let articles = this.props.articles;
            if(this.state.url){
                       $.ajax({
                           url: this.state.url,
                           data: {
                               from: this.state.from,
                               size: this.state.size
                           },
                           async: false,
                           success: function(resp){
                                let data = eval("("+resp+")");
                                articles = data.articles;
                                $('#page').jqPaginator('option', {
                                    totalPages: data.count
                                });
                            }
                       });
            }
            let list = articles.map((article) => (
                    <a href="#" value={gen_url(article.id)} onClick={common.aside.handleClick} className="list-group-item" key={gen_url(article.id)}>
                        <i className={article.feature?"fa icon-star":"fa icon-star-empty"} ></i>&nbsp;&nbsp;
                        <span>{article.title}</span>
                        <input type="hidden" value={article.author}/>
                        <input type="hidden" value={article.created_at}/>
                        <input type="hidden" value={article.id}/>
                        <span className="span-right">{parseDate(article.created_at).format("YYYY-MM-DD HH:mm:ss")}</span>
                    </a>
            ));
            return (<div className="col-md-8 blog-main">
                <header>
                    <h3>全部文章</h3>
                </header>
                <div className="body">
                    <div className="list-group">
                        {list}
                    </div>
                </div>
                <ul id="page" className="pagination"></ul>
            </div>)
        }
    }


    class Article extends React.Component {
        constructor(props) {
            super(props);
            this.handleClick = this.handleClick.bind(this);
            this.state = {};
        }

        handleClick(e) {
            this.props.parent.setState({url: null})

        }

        render() {
            console.log(this.props);
            let img =  this.props.first_img || '{{url_for("static", filename="img/pretty")}}/' + Math.floor(Math.random() * 1) + ".jpg";
            let edit_url = "{{url_for('edit')}}?id=" + this.props.id;
            let delete_url = "{{url_for('delete')}}?id=" + this.props.id;
            return (<div className="col-md-8 blog-main">
                <article className="blog-post">
                    <header>
                        <div class="lead-image">
                            <img src={img} alt="" className="img-responsive"/>
                        </div>
                        <h1>{this.props.title}</h1>
                        <div className="meta">
                            <i className={this.props.author ? "fa icon-user" : ""}></i> {this.props.author}
                            <i className={this.props.created_at ? "fa icon-calendar" : ""}></i>
                            {parseDate(this.props.created_at).format("YYYY-MM-DD HH:mm:ss")}
                            <a href="#"><i className="fa  icon-reply" onClick={this.handleClick}></i></a>
                            <a href={edit_url}><i className="fa icon-edit"></i></a>
                            <a href={delete_url}><i className="fa icon-remove-sign"></i></a>
                        </div>
                    </header>
                    {this.props.children}
                </article>
            </div>)
        }
    }

    function Block(props){
        let img = props.first_img || '{{url_for("static", filename="img/pretty")}}/' + Math.floor(Math.random()*1) + ".jpg";
        return (<div className="col-md-6 col-sm-6">
                    <article className=" blog-teaser">
                        <header>
                            <img src={img} alt=""/>
                            <h3>{props.title}</h3>
                            <span className="meta">
                                <i className={props.created_at ? "fa icon-calendar" : ""}></i><span>{parseDate(props.created_at).format("YYYY-MM-DD HH:mm:ss")}</span>
                                <i className={props.author ? "fa icon-user" : ""}></i><font>{props.author}</font>
                            </span>
                        </header>
                        <div className="body">
                           {props.description}
                        </div>
                        {props.children}
                    </article>
                </div>)
    }

    class Row extends React.Component {
        constructor(props) {
            super(props);
            common.row = this;
            this.handleClick = this.handleClick.bind(this);
            this.state = {};
        }

        handleClick(e) {
            let target = $(e.target);
            this.setState({
                url: target.val(),
                title: target.parent().parent().find("h3").html(),
                created_at: target.parent().parent().find("header span span").html(),
                author: target.parent().parent().find("header span font").html(),
                id: /id=(\w+)/.exec(target.val())[1]});

        }

        render() {
            if(this.state.url){
                let data = null;
                $.ajax({
                    url: this.state.url,
                    async: false,
                    success: function(resp){
                        data = eval("("+resp+")");
                    }
                });
                let html = { __html: data.article};
                data.article = null;
                data.parent = this;
                return (<Article {...data}>
                            <div dangerouslySetInnerHTML={html} className="body"/>
                        </Article>)
            }
            if(this.state.showList){
                let data = null;
                $.ajax({
                    url: "{{url_for('show')}}",
                    data: {"from": 0, "size": 20},
                    async: false,
                    success: function(resp){
                        data = eval("("+resp+")");
                    }
                });
                return (<List {...data} />)
            }
            let count = 0;
            let rows = [];
            while(true){
                let article1 = this.props.articles[count];
                let article2 = this.props.articles[count+1];
                if(!(article2 || article1)){
                    break;
                }else{
                    rows.push([article1, article2]);
                }
                count += 2;
            }
            let that = this;
            return (<div  className="col-md-8 blog-main">{rows.map(function(blocks){
                return (<div className="row" key={blocks[0].id}>{gen_block(blocks[0], that)} {gen_block(blocks[1], that)}</div>)
            })}
                <div className="paging">
                    <a href="#" onClick={(() => this.setState({"showList": true}))} className="older">全部文章</a>
                </div>
            </div>)
        }
    }

    class Aside extends React.Component {
        constructor(props) {
            super(props);
            this.handleClick = this.handleClick.bind(this);
            common["aside"] = this;
            this.state = {};
        }

        handleClick(e) {
            let target = $(e.target);
            common.row.setState({
                url: target.parent().val(),
                title: target.html(),
                created_at: target.parent().children("input")[1].value,
                author: target.parent().children("input")[0].value,
                id: /id=(\w+)/.exec(target.parent().val())[1]});
        }

        render() {
            let that = this;
            let feature_list = this.props.feature_articles.map(function(article){
                return (<a href="#" value={gen_url(article.id)} onClick={that.handleClick} className="list-group-item" key={gen_url(article.id)}>
                            <i className="fa  icon-star" ></i>&nbsp;&nbsp;
                            <span>{article.title}</span>
                            <input type="hidden" value={article.author}/>
                            <input type="hidden" value={article.created_at}/>
                            <input type="hidden" value={article.id}/>
                        </a>);
            });
            let recent_list = this.props.articles.map(function(article){
                return (<a href="#" value={gen_url(article.id)} onClick={that.handleClick} className="list-group-item" key={article.id}>
                            <i className={article.feature ? "fa icon-star" : "fa icon-star-empty"} ></i>&nbsp;&nbsp;
                            <span>{article.title}</span>
                            <input type="hidden" value={article.author}/>
                            <input type="hidden" value={article.created_at}/>
                            <input type="hidden" value={article.id}/>
                        </a>);
            });
            let tags = this.props.tags.map(
                (tag) => (<li key={tag}><a href="#" onClick={common.container.handleClick} value={tag}>{tag}</a></li>)
            );
            return (<aside className="col-md-4 blog-aside">
                        <div className="aside-widget">
                            <header>
                                <h3>精品文章</h3>
                            </header>
                            <div className="body">
                                <ul className="list-group">
                                    {feature_list}
                                </ul>
                            </div>
                        </div>

                        <div className="aside-widget">
                            <header>
                                <h3>最近发布</h3>
                            </header>
                            <div className="body">
                                <div className="list-group">
                                    {recent_list}
                                </div>
                            </div>
                        </div>

                        <div className="aside-widget">
                            <header>
                                <h3>标签</h3>
                            </header>
                            <div className="body clearfix">
                                <ul className="tags">
                                    {tags}
                                </ul>
                            </div>
                        </div>
                    </aside>)
        }
    }

    function Page(props){
        let data = null;
        // 用来在多个并行组件之间传递参数
        $.ajax({
            url: '{{url_for("show")}}',
            data: {"searchField": props.searchField},
            async: false,
            success: function(resp){
                data = eval("("+resp+")");
            }
        });
        let row = (<Row {...{"articles": data.articles.slice(0, 4)}}/>);
        let aside = (<Aside {...{"feature_articles": data.feature_articles.slice(0, 6),
            "articles": data.articles.slice(0, 6), "tags": data.tags}}/>);
        return (<div className="container">
        <div className="row">
            {row}
            {aside}
        </div>
    </div>)
    }

     class Container extends React.Component{
        constructor(props) {
            super(props);
            common.container = this;
            this.handleClick = this.handleClick.bind(this);
            this.state = {};
        }

        handleClick(e){
            this.setState({searchField: $(e.target).val() || $("#searchField").val()});
        }

        render(){
            return (<div><div className="widewrapper subheader">
            <div className="container">
                <div className="clean-breadcrumb">
                    <span>博客</span>
                </div>

                <div className="clean-searchbox">
                    <input className="searchfield" id="searchField" type="text" placeholder="Search"/>
                    <button className="searchbutton" onClick={this.handleClick}>
                        <i className="fa icon-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <Page {...this.state}/>
            </div>)
        }
    }
    Container.defaultProps = {
    };

    class Header extends React.Component{
        constructor(props) {
            super(props);
            this.handleClick = this.handleClick.bind(this);
            this.state = {};
        }

        handleClick(e){
            let target = $(e.target);
            if(target.val() == "1"){
                location.href = '{{url_for("index")}}';
            }else if(target.val() == "2"){
                common.row.setState({
                    url: "{{url_for('me')}}",
                    id: "我的自我介绍"
                });
            }else{
                common.row.setState({
                    url: "{{url_for('contact')}}",
                    id: "我的联系方式"
                });
            }

        }

        render(){
            return (<div>
                        <a href="#" onClick={this.handleClick} id="logo">
                            <img value="1" src='{{url_for("static", filename="img/logo.png")}}' alt="clean Blog"/>
                        </a>
                    <div id="mobile-nav-toggle" className="pull-right">
                        <a href="#" data-toggle="collapse" data-target=".clean-nav .navbar-collapse">
                            <i className="fa fa-bars"></i>
                        </a>
                    </div>

                    <nav className="pull-right clean-nav">
                        <div className="collapse navbar-collapse">
                            <ul className="nav nav-pills navbar-nav">

                                <li>
                                    <a href="#" value="1" onClick={this.handleClick}>主页</a>
                                </li>
                                <li>
                                    <a href="#" value="2" onClick={this.handleClick}>关于我</a>
                                </li>
                                <li>
                                    <a href="#" value="3" onClick={this.handleClick}>联系我</a>
                                </li>
                            </ul>
                        </div>
                    </nav></div>)
        }
    }

    ReactDOM.render(
        <Container/>, document.getElementById("body")
    );

    ReactDOM.render(
        <Header/>, document.getElementById("header")
    );
</script>
<body>
    <header>
        <div class="widewrapper masthead">
            <div class="container" id="header">
            </div>
        </div>

    </header>

    <div class="widewrapper main" id="body"></div>

    <footer>
        <div class="widewrapper footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-4 footer-widget">
                        <h3> <i class="fa icon-user"></i>关于</h3>

                       <p>这是我的第一个个人博客，若有bug或缺陷，请及时联系我。</p>
                       <p>博文支持markdown格式的上传和编辑。支持全文搜索。</p>
                       <p>后续会增加评论功能，请多关注。</p>
                    </div>

                    <div class="col-md-4 footer-widget">
                        <h3> <i class="fa icon-legal"></i>技术栈</h3>
                        <ul class="clean-list">
                            <li><a href="#">python</a></li>
                            <li><a href="#">flask</a></li>
                            <li><a href="#">sqlite3</a></li>
                            <li><a href="#">react</a></li>
                            <li><a href="#">bootstrap</a></li>
                            <li><a href="#">elasticsearch</a></li>
                            <li><a href="#">markdown</a></li>
                            <li><a href="#">docker</a></li>
                            <li><a href="#">raspberry</a></li>
                        </ul>
                    </div>

                    <div class="col-md-4 footer-widget">
                        <h3> <i class="fa icon-mobile-phone"></i>联系我</h3>

                        <p>如果您对技术感兴趣或者需要合作，请点击页面右上角联系我，以上拥有我全部的联系方式</p>
                        <p>期待与您合作</p>
                    </div>
                    <div class="footer-widget-icon">
                            <a href="https://github.com/ShichaoMa"><i class="fa icon-github"></i></a>
                            <a href="https://twitter.com/cnaafhvk"><i class="fa icon-twitter"></i></a>
                            <i class="fa icon-facebook"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="widewrapper copyright">
                Copyright 2017
        </div>
    </footer>
</body>
</html>